<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff • Today’s Logbooks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background:#f8f9fa; color:#212529; }
    header {
      position: sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:1px solid #dee2e6; background:#ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { margin:0; font-size:16px; }
    .sub { font-size:12px; color:#6c757d; margin-top:2px; }
    .btn {
      border-radius:50px; border:1px solid #dee2e6; background:#ffffff; color:#212529;
      padding:10px 16px; font-size:15px; min-height:44px; cursor:pointer; transition: background-color 0.2s, border-color 0.2s;
    }
    .btn:hover { background:#e9ecef; }
    .btn.primary { background:#007bff; border-color:#007bff; color:white; }
    .btn.primary:hover { background:#0056b3; }
    .badge {
      font-size:13px; padding:8px 14px; border-radius:50px;
      border:1px solid #dee2e6; background:#ffffff;
      display:inline-flex; align-items:center; gap:6px; min-height:32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .badge::before { content:"●"; font-size:10px; color:#6c757d; }
    .badge.ok { border-color:#28a745; color:#155724; background:#d4edda; }
    .badge.ok::before { color:#28a745; }
    .badge.error { border-color:#dc3545; color:#721c24; background:#f8d7da; }
    .badge.error::before { color:#dc3545; }
    main { padding:14px; max-width:920px; margin:0 auto; }
    .card {
      border:1px solid #dee2e6; border-radius:8px; padding:14px;
      background:#ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .grid { display:flex; flex-direction:column; gap:10px; margin-top:14px; }
    .item {
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border:1px solid #dee2e6; border-radius:8px; padding:12px 14px;
      background:#ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s;
    }
    .item:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .title { font-weight:600; }
    .meta { font-size:12px; color:#6c757d; }
    .pill { font-size:12px; padding:6px 10px; border-radius:50px; border:1px solid #dee2e6; color:#6c757d; background:#f8f9fa; }
  </style>
</head>
<!-- Body with header and main content -->
<body>
  <!-- Header with title, store info, and controls -->
  <header>
    <div>
      <h1>Staff • Today's Logbooks</h1>
      <div class="sub" id="storeLine">Store: (loading)</div>
    </div>
    <div class="row">
      <!-- Status badge -->
      <span id="status" class="badge">Initialising…</span>
      <!-- Back button -->
      <button id="backBtn" class="btn">⬅ Back</button>
      <!-- Refresh button -->
      <button id="refreshBtn" class="btn">↻ Refresh</button>
    </div>
  </header>

  <!-- Main content area -->
  <main>
    <!-- Card for generating today's logbooks (hidden initially) -->
    <div class="card" id="generateCard" style="display:none;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="title">Today's Logbooks</div>
          <div class="meta">Generate today's logbooks from the store assignments.</div>
        </div>
        <!-- Generate button -->
        <button id="generateBtn" class="btn primary">Generate today's logbooks</button>
      </div>
    </div>

    <!-- Container for the list of logbooks -->
    <div class="grid" id="list"></div>
  </main>

  <!-- JavaScript module for Firebase integration -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, getDocs, setDoc, query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase configuration object
    const firebaseConfig = {
      apiKey: "AIzaSyD--9gIymq-tT-o9CGp32W7GFtgXuGQeJymq-tT-o9CGp32W7GFtgXuGQeJw".replace("AIzaSyD--9gIymq-tT-o9CGp32W7GFtgXuGQeJymq-tT-o9CGp32W7GFtgXuGQeJw","AIzaSyD--9gIymq-tT-o9CGp32W7GFtgXuGQeJw"),
      authDomain: "dradanddrop-bb7c5.firebaseapp.com",
      projectId: "dradanddrop-bb7c5",
      storageBucket: "dradanddrop-bb7c5.firebasestorage.app",
      messagingSenderId: "907742522220",
      appId: "1:907742522220:web:4fd124ca048626c9e1e149",
      measurementId: "G-W83330W3GJ"
    };

    // Initialize Firebase app
    const app = initializeApp(firebaseConfig);
    // Get Firestore database instance
    const db = getFirestore(app);

    // DOM element references
    const statusEl = document.getElementById("status");
    const storeLine = document.getElementById("storeLine");
    const generateCard = document.getElementById("generateCard");
    const listEl = document.getElementById("list");
    const backBtn = document.getElementById("backBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const generateBtn = document.getElementById("generateBtn");

    // Page constants
    const HOME_PAGE = "index.html";
    const FILL_PAGE = "fill.html"; // will open with templateId + instanceId

    // Get URL parameters
    const params = new URLSearchParams(location.search);
    const storeId = params.get("storeId");

    // Function to update status badge
    function setStatus(msg, kind="info") {
      statusEl.textContent = msg;
      statusEl.classList.remove("ok","error");
      if (kind === "ok") statusEl.classList.add("ok");
      if (kind === "error") statusEl.classList.add("error");
    }

    // Event listeners for buttons
    backBtn.addEventListener("click", () => location.href = HOME_PAGE);
    refreshBtn.addEventListener("click", () => loadToday());

    // Check if storeId is provided in URL
    if (!storeId) {
      // Store picker mode (no storeId in URL)
      storeLine.textContent = "Store: (choose a store)";
      setStatus("Pick a store to continue", "error");

      // No store selected yet → hide generate action + disable refresh.
      generateCard.style.display = "none";

      // Create store picker card
      const pickerCard = document.createElement("div");
      pickerCard.className = "card";
      pickerCard.innerHTML = `
        <div class="title">Select a store</div>
        <div class="meta" style="margin-top:6px;">This page needs to know which store you are viewing. Choose one below.</div>
        <div class="row" id="pickerButtons" style="margin-top:12px;"></div>
      `;
      listEl.innerHTML = "";
      listEl.appendChild(pickerCard);

      const buttonsEl = pickerCard.querySelector("#pickerButtons");
      buttonsEl.innerHTML = `<span class="meta">Loading stores…</span>`;

      // Async function to load and display stores
      (async () => {
        try {
          // Fetch stores from Firestore
          const snap = await getDocs(collection(db, "stores"));
          const items = [];
          snap.forEach(d => items.push({ id: d.id, ...d.data() }));
          // Sort stores by name or id
          items.sort((a,b) => String(a.name||a.id).localeCompare(String(b.name||b.id)));

          if (!items.length) {
            buttonsEl.innerHTML = `<div class="meta">No stores found</div>`;
            setStatus("No stores in Firestore yet (create one on Home).", "error");
            return;
          }

          // Render stores as buttons
          buttonsEl.innerHTML = items.map(s => {
            const name = s.name ? `${s.name} (${s.id})` : s.id;
            return `<button class="btn" data-store-id="${s.id}">${name}</button>`;
          }).join("");

          // Event listener for store selection
          buttonsEl.addEventListener("click", (ev) => {
            const btn = ev.target.closest("button[data-store-id]");
            if (!btn) return;
            const chosen = btn.getAttribute("data-store-id");
            // Redirect to today.html with selected storeId
            location.href = `today.html?storeId=${encodeURIComponent(chosen)}`;
          });

          setStatus("Select a store", "ok");
        } catch (e) {
          console.error(e);
          buttonsEl.innerHTML = `<div class="meta">Failed to load stores</div>`;
          setStatus("Failed to load stores (check Firestore rules).", "error");
        }
      })();

      refreshBtn.disabled = true;

      throw new Error("Missing storeId (picker shown)");
    }

    // Get today's date in ISO format
    const today = new Date();
    const todayISO = today.toISOString().slice(0,10); // YYYY-MM-DD
    storeLine.textContent = "Store: " + storeId;

    // Store selected → show generate action.
    generateCard.style.display = "block";

    // Function to ensure today's logbook instances exist
    async function ensureTodayInstances() {
      setStatus("Generating…");
      // Load rules for this store
      const rulesQ = query(collection(db, "store_template_rules"), where("storeId","==", storeId));
      const rulesSnap = await getDocs(rulesQ);

      if (rulesSnap.empty) {
        setStatus("No assignments for this store.", "error");
        return;
      }

      // Create instances for each template assigned to the store
      for (const rDoc of rulesSnap.docs) {
        const r = rDoc.data();
        const templateId = r.templateId;
        if (!templateId) continue;

        const instanceId = `${storeId}__${templateId}__${todayISO}`;
        await setDoc(doc(db, "logbook_instances", instanceId), {
          storeId,
          templateId,
          templateName: r.templateName || null,
          date: todayISO,
          status: "not_started",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      }

      setStatus("Generated/updated.", "ok");
    }

    // Function to render a logbook item
    function renderItem(inst) {
      const div = document.createElement("div");
      div.className = "item";

      const left = document.createElement("div");
      const title = document.createElement("div");
      title.className = "title";
      title.textContent = inst.templateName || "Logbook";
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `TemplateId: ${inst.templateId} • InstanceId: ${inst.id}`;
      left.appendChild(title);
      left.appendChild(meta);

      const right = document.createElement("div");
      right.className = "row";

      const pill = document.createElement("span");
      pill.className = "pill";
      pill.textContent = inst.status || "not_started";

      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.textContent = "Open";
      btn.addEventListener("click", () => {
        // Open fill page with necessary parameters
        location.href = `${FILL_PAGE}?instanceId=${encodeURIComponent(inst.id)}&templateId=${encodeURIComponent(inst.templateId)}&storeId=${encodeURIComponent(storeId)}&date=${encodeURIComponent(todayISO)}`;
      });

      right.appendChild(pill);
      right.appendChild(btn);

      div.appendChild(left);
      div.appendChild(right);
      return div;
    }

    // Function to load today's logbooks
    async function loadToday() {
      setStatus("Loading…");
      listEl.innerHTML = "";

      // Load store name (optional)
      const storeDoc = await getDoc(doc(db, "stores", storeId));
      if (storeDoc.exists()) {
        const d = storeDoc.data();
        storeLine.textContent = "Store: " + (d.name ? `${d.name} (${storeId})` : storeId);
      }

      // Query for today's instances
      const qInst = query(
        collection(db, "logbook_instances"),
        where("storeId","==", storeId),
        where("date","==", todayISO)
      );
      const instSnap = await getDocs(qInst);

      if (instSnap.empty) {
        const empty = document.createElement("div");
        empty.className = "card";
        empty.innerHTML = `<div class="title">No logbooks for today yet</div><div class="meta">Tap "Generate today's logbooks" to create them from the store assignments.</div>`;
        listEl.appendChild(empty);
        setStatus("No instances yet.", "error");
        return;
      }

      const items = instSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      // Sort by template name
      items.sort((a,b) => String(a.templateName||"").localeCompare(String(b.templateName||"")));
      items.forEach(x => listEl.appendChild(renderItem(x)));

      setStatus("Loaded " + items.length, "ok");
    }

    // Event listener for generate button
    generateBtn.addEventListener("click", async () => {
      try {
        await ensureTodayInstances();
        await loadToday();
      } catch (e) {
        console.error(e);
        setStatus("Failed (check Firestore rules).", "error");
      }
    });

    // Initial load on page load
    setStatus("Ready");
    loadToday();
  </script>
</body>
</html>
