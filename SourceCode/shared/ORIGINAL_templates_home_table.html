<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Logbook Templates Home (Firestore)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Arial, sans-serif; background:#0b1220; color:#e5e7eb; }
    header {
      position: sticky; top: 0; z-index: 10;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:14px 16px; background:rgba(2,6,23,0.92); border-bottom:1px solid #1f2937; backdrop-filter: blur(10px);
    }
    header h1 { margin:0; font-size:18px; letter-spacing:.02em; }
    header .sub { margin:2px 0 0; font-size:12px; color:#94a3b8; }
    .right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge {
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(59,130,246,.35); background:rgba(59,130,246,.12); color:#bfdbfe;
      white-space: nowrap;
    }
    .badge.success { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color:#bbf7d0; }
    .badge.error { border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); color:#fecaca; }
    .btn {
      border-radius:999px; border:1px solid #334155; background:#020617; color:#e5e7eb;
      padding:12px 14px; font-size:14px; min-height:46px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn.primary { background:#2563eb; border-color:#2563eb; color:white; }
    .btn:hover { border-color:#475569; background:#030712; }
    .btn.primary:hover { filter: brightness(1.05); }
    main { max-width: 1100px; margin: 18px auto 42px; padding: 0 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    .card {
      background: rgba(2,6,23,0.85);
      border: 1px solid #1f2937;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.45);
    }
    .card-top { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .name { font-weight:800; font-size:16px; letter-spacing:.02em; }
    .meta { color:#94a3b8; font-size:12px; margin-top:4px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
    .small {
      padding:10px 12px;
      min-height:44px;
      font-size:14px;
    }
    .danger { border-color: rgba(239,68,68,.55); }
    .danger:hover { background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.7); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    input[type="text"]{
      flex:1;
      min-width: 220px;
      background:#020617; color:#e5e7eb;
      border:1px solid #334155;
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      min-height: 46px;
      box-sizing: border-box;
    }
    .empty {
      border:1px dashed #334155;
      border-radius: 18px;
      padding: 20px;
      text-align:center;
      color:#94a3b8;
      background: rgba(2,6,23,0.55);
    }
    .hint { color:#94a3b8; font-size:12px; margin-top:8px; }
    @media (min-width: 860px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Logbook Templates</h1>
      <div class="sub">Create logbooks, edit templates, fill entries and export PDFs.</div>
    </div>
    <div class="right">
      <span id="status" class="badge">Loadingâ€¦</span>
      <button id="refreshBtn" class="btn">â†» Refresh</button>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="name">Create a new logbook</div>
      <div class="meta">Give it a name, then edit the template using the Builder.</div>
      <div class="row">
        <input id="newName" type="text" placeholder="e.g. Fridge & Freezer Temperature Log" />
        <button id="createBtn" class="btn primary">ï¼‹ Create</button>
      </div>
      <div class="hint">Tip: After creating, tap <b>Edit Template</b> to add headings + tables.</div>
    
    <div class="card">
      <div class="name">Assign templates to stores (daily)</div>
      <div class="meta">Choose a store and a template, then assign it so it appears every day to be filled out.</div>

      <div class="row" style="flex-wrap:wrap;">
        <select id="storeSelect" class="select">
          <option value="">Select storeâ€¦</option>
        </select>

        <select id="templateSelect" class="select">
          <option value="">Select templateâ€¦</option>
        </select>

        <button id="assignBtn" class="btn primary">ï¼‹ Assign (Daily)</button>
        <button id="openTodayBtn" class="btn">ðŸ“… Today</button>
      </div>

      <div class="row" style="flex-wrap:wrap; margin-top:10px;">
        <input id="newStoreName" type="text" placeholder="New store name (e.g. Friary Mill Plymouth)" />
        <input id="newStoreCode" type="text" placeholder="Store code (e.g. PLYMOUTH)" />
        <button id="createStoreBtn" class="btn">ï¼‹ Create store</button>
      </div>

      <div id="assignStatus" class="hint" style="margin-top:10px;">Tip: Store code becomes the Store ID.</div>

      <div style="height:10px;"></div>
      <div class="meta" style="margin-bottom:6px;">Assignments for selected store:</div>
      <div id="rulesList" class="rules"></div>
    </div>

    <div style="height:14px;"></div>

    <div id="list" class="grid"></div>

  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, doc, addDoc, getDocs, getDoc, updateDoc, deleteDoc, serverTimestamp,
      setDoc, query, where
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase config (your project)
    const firebaseConfig = {
      apiKey: "AIzaSyD--9gIymq-tT-o9CGp32W7GFtgXuGQeJw",
      authDomain: "dradanddrop-bb7c5.firebaseapp.com",
      projectId: "dradanddrop-bb7c5",
      storageBucket: "dradanddrop-bb7c5.firebasestorage.app",
      messagingSenderId: "907742522220",
      appId: "1:907742522220:web:4fd124ca048626c9e1e149",
      measurementId: "G-W83330W3GJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const statusEl = document.getElementById("status");
    const refreshBtn = document.getElementById("refreshBtn");
    const listEl = document.getElementById("list");

    // --- Assignment UI refs ---
    const storeSelect = document.getElementById("storeSelect");
    const templateSelect = document.getElementById("templateSelect");
    const assignBtn = document.getElementById("assignBtn");
    const openTodayBtn = document.getElementById("openTodayBtn");
    const assignStatus = document.getElementById("assignStatus");
    const rulesList = document.getElementById("rulesList");
    const newStoreName = document.getElementById("newStoreName");
    const newStoreCode = document.getElementById("newStoreCode");
    const createStoreBtn = document.getElementById("createStoreBtn");

    function setAssignStatus(msg, kind="info") {
      if (!assignStatus) return;
      assignStatus.textContent = msg;
      assignStatus.style.color = (kind==="error") ? "#fca5a5" : (kind==="ok") ? "#86efac" : "#9ca3af";
    }

    const storesCol = collection(db, "stores");
    const rulesCol = collection(db, "store_template_rules");

    async function loadStores() {
      if (!storeSelect) return;
      storeSelect.innerHTML = '<option value="">Select storeâ€¦</option>';
      const snap = await getDocs(storesCol);
      snap.forEach(s => {
        const d = s.data();
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = d.name ? `${d.name} (${s.id})` : s.id;
        storeSelect.appendChild(opt);
      });
    }

    function fillTemplateSelect(templates) {
      if (!templateSelect) return;
      const prev = templateSelect.value;
      templateSelect.innerHTML = '<option value="">Select templateâ€¦</option>';
      templates.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name ? t.name : t.id;
        templateSelect.appendChild(opt);
      });
      templateSelect.value = prev;
    }

    async function loadRulesForStore(storeId) {
      if (!rulesList) return;
      rulesList.innerHTML = "";
      if (!storeId) return;

      const q = query(rulesCol, where("storeId", "==", storeId));
      const snap = await getDocs(q);

      if (snap.empty) {
        const div = document.createElement("div");
        div.className = "hint";
        div.textContent = "No assignments yet for this store.";
        rulesList.appendChild(div);
        return;
      }

      snap.forEach(docSnap => {
        const r = docSnap.data();
        const wrap = document.createElement("div");
        wrap.className = "rule-item";

        const left = document.createElement("div");
        left.className = "left";
        const title = document.createElement("div");
        title.className = "title";
        title.textContent = r.templateName ? r.templateName : (r.templateId || "Template");
        const sub = document.createElement("div");
        sub.className = "sub";
        sub.textContent = `TemplateId: ${r.templateId} â€¢ Frequency: ${r.frequency || "daily"}`;
        left.appendChild(title);
        left.appendChild(sub);

        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Unassign";
        btn.addEventListener("click", async () => {
          if (!confirm("Remove this assignment?")) return;
          try {
            await deleteDoc(doc(db, "store_template_rules", docSnap.id));
            setAssignStatus("Assignment removed.", "ok");
            await loadRulesForStore(storeId);
          } catch (e) {
            console.error(e);
            setAssignStatus("Failed to remove assignment.", "error");
          }
        });

        wrap.appendChild(left);
        wrap.appendChild(btn);
        rulesList.appendChild(wrap);
      });
    }

    if (storeSelect) {
      storeSelect.addEventListener("change", () => {
        loadRulesForStore(storeSelect.value);
      });
    }

    if (createStoreBtn) {
      createStoreBtn.addEventListener("click", async () => {
        const name = (newStoreName?.value || "").trim();
        const code = (newStoreCode?.value || "").trim().toUpperCase();
        if (!name || !code) {
          setAssignStatus("Enter both store name and store code.", "error");
          return;
        }
        try {
          setAssignStatus("Creating storeâ€¦");
          await setDoc(doc(db, "stores", code), {
            name,
            createdAt: serverTimestamp()
          }, { merge: true });
          newStoreName.value = "";
          newStoreCode.value = "";
          await loadStores();
          storeSelect.value = code;
          await loadRulesForStore(code);
          setAssignStatus("Store created.", "ok");
        } catch (e) {
          console.error(e);
          setAssignStatus("Failed to create store (check Firestore rules).", "error");
        }
      });
    }

    if (assignBtn) {
      assignBtn.addEventListener("click", async () => {
        const storeId = storeSelect?.value;
        const templateId = templateSelect?.value;
        if (!storeId || !templateId) {
          setAssignStatus("Select a store and a template.", "error");
          return;
        }
        try {
          setAssignStatus("Saving assignmentâ€¦");
          // deterministic doc id prevents duplicates
          const ruleId = `${storeId}__${templateId}__daily`;
          // Try to include the template name for nicer display
          const t = window.__TEMPLATES_CACHE?.find(x => x.id === templateId);
          await setDoc(doc(db, "store_template_rules", ruleId), {
            storeId,
            templateId,
            templateName: t?.name || null,
            frequency: "daily",
            updatedAt: serverTimestamp()
          }, { merge: true });

          await loadRulesForStore(storeId);
          setAssignStatus("Assigned (daily).", "ok");
        } catch (e) {
          console.error(e);
          setAssignStatus("Failed to assign (check Firestore rules).", "error");
        }
      });
    }

    if (openTodayBtn) {
      openTodayBtn.addEventListener("click", () => {
        const storeId = storeSelect?.value;
        if (!storeId) {
          setAssignStatus("Select a store first.", "error");
          return;
        }
        window.location.href = `today_logbooks.html?storeId=${encodeURIComponent(storeId)}`;
      });
    }

    const newNameEl = document.getElementById("newName");
    const createBtn = document.getElementById("createBtn");

    // Filenames (must match your downloaded files)
    const BUILDER_PAGE = "full_firestore_builder_table.html";
    const FILL_PAGE = "full_firestore_fill_pdf_table.html";

    function setStatus(msg, kind="info") {
      statusEl.textContent = msg;
      statusEl.classList.remove("success","error");
      if (kind === "success") statusEl.classList.add("success");
      if (kind === "error") statusEl.classList.add("error");
    }

    async function loadTemplates() {
      setStatus("Loading logbooksâ€¦", "info");
      listEl.innerHTML = "";
      try {
        const snap = await getDocs(collection(db, "logbook_templates"));
        if (snap.empty) {
          listEl.innerHTML = '<div class="empty">No logbooks yet. Create one above.</div>';
          setStatus("No logbooks found", "info");
          return;
        }

        const items = [];
        snap.forEach(d => items.push({ id: d.id, ...d.data() }));

        // Sort by created_at if present (fallback to name)
        items.sort((a,b) => {
          const da = a.created_at ? String(a.created_at) : "";
          const dbb = b.created_at ? String(b.created_at) : "";
          if (da && dbb) return dbb.localeCompare(da);
          return String(a.name||"").localeCompare(String(b.name||""));
        });

        // Cache templates for assignment dropdown
        window.__TEMPLATES_CACHE = items;
        fillTemplateSelect(items);


        for (const t of items) {
          listEl.appendChild(renderTemplateCard(t));
        }

        setStatus(`Loaded ${items.length} logbook(s)`, "success");
      } catch (e) {
        console.error(e);
        setStatus("Failed to load logbooks", "error");
        listEl.innerHTML = '<div class="empty">Error loading logbooks. Check Firestore rules and console.</div>';
      }
    }

    function renderTemplateCard(t) {
      const card = document.createElement("div");
      card.className = "card";

      const top = document.createElement("div");
      top.className = "card-top";

      const left = document.createElement("div");
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = t.name || "Untitled Logbook";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `Template ID: ${t.id}`;

      left.appendChild(name);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "actions";

      const editBtn = document.createElement("button");
      editBtn.className = "btn small primary";
      editBtn.textContent = "âœï¸ Edit Template";
      editBtn.addEventListener("click", () => {
        window.location.href = `${BUILDER_PAGE}?templateId=${encodeURIComponent(t.id)}`;
      });

      const fillBtn = document.createElement("button");
      fillBtn.className = "btn small";
      fillBtn.textContent = "ðŸ“ Fill & Export PDF";
      fillBtn.addEventListener("click", () => {
        window.location.href = `${FILL_PAGE}?templateId=${encodeURIComponent(t.id)}`;
      });

      const renameBtn = document.createElement("button");
      renameBtn.className = "btn small";
      renameBtn.textContent = "Rename";
      renameBtn.addEventListener("click", async () => {
        const newName = prompt("New logbook name:", t.name || "Untitled Logbook");
        if (!newName || !newName.trim()) return;
        try {
          await updateDoc(doc(db, "logbook_templates", t.id), { name: newName.trim() });
          setStatus("Renamed", "success");
          await loadTemplates();
        } catch (e) {
          console.error(e);
          setStatus("Rename failed", "error");
        }
      });

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "btn small danger";
      deleteBtn.textContent = "Delete";
      deleteBtn.addEventListener("click", async () => {
        if (!confirm("Delete this logbook template?\n\nNote: this only deletes the template document. Subcollection cleanup may require manual delete in Firebase console.")) return;
        try {
          await deleteDoc(doc(db, "logbook_templates", t.id));
          setStatus("Deleted template (doc)", "success");
          await loadTemplates();
        } catch (e) {
          console.error(e);
          setStatus("Delete failed", "error");
        }
      });

      actions.appendChild(editBtn);
      actions.appendChild(fillBtn);
      actions.appendChild(renameBtn);
      actions.appendChild(deleteBtn);

      top.appendChild(left);
      top.appendChild(actions);
      card.appendChild(top);

      return card;
    }

    async function createTemplate() {
      const name = (newNameEl.value || "").trim();
      if (!name) { setStatus("Enter a name first", "error"); return; }
      createBtn.disabled = true;
      setStatus("Creatingâ€¦", "info");
      try {
        const ref = await addDoc(collection(db, "logbook_templates"), {
          name,
          created_at: new Date().toISOString()
        });
        newNameEl.value = "";
        setStatus("Created", "success");
        // jump straight into builder
        window.location.href = `${BUILDER_PAGE}?templateId=${encodeURIComponent(ref.id)}`;
      } catch (e) {
        console.error(e);
        setStatus("Create failed", "error");
      } finally {
        createBtn.disabled = false;
      }
    }

    createBtn.addEventListener("click", createTemplate);
    newNameEl.addEventListener("keydown", (e) => { if (e.key === "Enter") createTemplate(); });
    refreshBtn.addEventListener("click", loadTemplates);

    await loadStores();
    loadTemplates();
  </script>
</body>
</html>
